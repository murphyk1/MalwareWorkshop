import os
import sys
import encryption_helper
import argparse
import json
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'phantom_ui.settings')

import django
django.setup()
from phantom_ui.ui.models import SystemSettings, PhUser

def main():
    parser = argparse.ArgumentParser(description="Handles interface with certain SOAR Admin Settings")
    parser.add_argument('--config', type=str, help='JSON Serializable config dictionary from ZCatman')
    args = parser.parse_args()
    if args.config:
        config = json.loads(args.config)
        phantom_key = config['phantom_api_key']
        phantom_base_url = config['phantom_base_url']
        ss = SystemSettings.get_settings()
        ss.environment_variables = {
            'PHANTOM_API_KEY': {'type': 'password', 'value': encryption_helper.encrypt(phantom_key, 'PHANTOM_API_KEY')},
            'NO_PROXY': {'type': 'text', 'value': '127.0.0.1,localhost'}
        }
        ss.administrator_contact = 'newadmin@localhost'
        ss.company_name = 'Splunk'
        ss.system_name = 'Splunk SOAR'
        ss.eula_accepted = True
        ss.fqdn = phantom_base_url
        ss.save(ignore_rabbit_error=True)

        admin_user = PhUser.objects.get(username='admin')
        admin_user.profile.onboarding_state = {'redirect_onboarding': False}
        admin_user.profile.save()
        admin_user.save()

if __name__ == '__main__':
    main()